<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />
<meta content="openpilot docs" name="description" />
<meta content="op, openpilot, docs, documentation" name="keywords" />
<meta content="all,follow" name="robots" />
<meta content="index,follow,snippet,archive" name="googlebot" />
<meta content="en_US" property="og:locale" />
<meta content="docs.comma.ai" property="og:site_name" />
<meta content="https://docs.comma.ai" property="og:url" />
<meta content="openpilot Documentation" property="og:title" />
<meta content="website" property="og:type" />
<meta content="image/jpeg" property="og:image:type" />
<meta content="400" property="og:image:width" />
<meta content="https://docs.comma.ai/_static/logo.png" property="og:image" />
<meta content="https://docs.comma.ai/_static/logo.png" property="og:image:url" />
<meta content="https://docs.comma.ai/_static/logo.png" property="og:image:secure_url" />
<meta content="openpilot Documentation" property="og:description" />
<meta content="summary_large_image" property="twitter:card" />
<meta content="https://docs.comma.ai/_static/logo.png" property="twitter:logo" />
<meta content="openpilot Documentation" property="twitter:title" />
<meta content="openpilot Documentation" property="twitter:description" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reference Frames &mdash; openpilot docs 0.9.5 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="canonical" href="https://docs.comma.ai/common/transformations/README.html" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=61b282d3"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #000000" >

          
          
          <a href="../../index.html" class="icon icon-home">
            openpilot docs
              <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.9.5
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">General</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../CARS.html">Supported Cars</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CARS.html#id1">265 Supported Cars</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CARS.html#don-t-see-your-car-here">Don’t see your car here?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CONTRIBUTING.html">How to contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../INTEGRATION.html">Integration with Stock Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LIMITATIONS.html">Limitations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SAFETY.html">Safety</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">openpilot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html#cereal">cereal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html#laika">laika</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html#models">models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html#opendbc">opendbc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html#panda">panda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html#rednose">rednose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html#tools">tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">openpilot</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">C/C++ API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../c_docs.html">openpilot</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #000000" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">openpilot docs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Reference Frames</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/common/transformations/README.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="reference-frames">
<h1>Reference Frames<a class="headerlink" href="#reference-frames" title="Link to this heading"></a></h1>
<p>Many reference frames are used throughout. This
folder contains all helper functions needed to
transform between them. Generally this is done
by generating a rotation matrix and multiplying.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-center"><p>Name</p></th>
<th class="head text-center"><p>[x, y, z]</p></th>
<th class="head text-center"><p>Units</p></th>
<th class="head text-center"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p>Geodetic</p></td>
<td class="text-center"><p>[Latitude, Longitude, Altitude]</p></td>
<td class="text-center"><p>geodetic coordinates</p></td>
<td class="text-center"><p>Sometimes used as [lon, lat, alt], avoid this frame.</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>ECEF</p></td>
<td class="text-center"><p>[x, y, z]</p></td>
<td class="text-center"><p>meters</p></td>
<td class="text-center"><p>We use <strong>ITRF14 (IGS14)</strong>, NOT NAD83. <br> This is the global Mesh3D frame.</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>NED</p></td>
<td class="text-center"><p>[North, East, Down]</p></td>
<td class="text-center"><p>meters</p></td>
<td class="text-center"><p>Relative to earth’s surface, useful for visualizing.</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>Device</p></td>
<td class="text-center"><p>[Forward, Right, Down]</p></td>
<td class="text-center"><p>meters</p></td>
<td class="text-center"><p>This is the Mesh3D local frame. <br> Relative to camera, <strong>not imu.</strong> <br> <img alt="img" src="http://upload.wikimedia.org/wikipedia/commons/thumb/2/2f/RPY_angles_of_airplanes.png/440px-RPY_angles_of_airplanes.png" /></p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>Calibrated</p></td>
<td class="text-center"><p>[Forward, Right, Down]</p></td>
<td class="text-center"><p>meters</p></td>
<td class="text-center"><p>This is the frame the model outputs are in. <br> More details below. <br></p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>Car</p></td>
<td class="text-center"><p>[Forward, Right, Down]</p></td>
<td class="text-center"><p>meters</p></td>
<td class="text-center"><p>This is useful for estimating position of points on the road. <br> More details below. <br></p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>View</p></td>
<td class="text-center"><p>[Right, Down, Forward]</p></td>
<td class="text-center"><p>meters</p></td>
<td class="text-center"><p>Like device frame, but according to camera conventions.</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>Camera</p></td>
<td class="text-center"><p>[u, v, focal]</p></td>
<td class="text-center"><p>pixels</p></td>
<td class="text-center"><p>Like view frame, but 2d on the camera image.</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>Normalized Camera</p></td>
<td class="text-center"><p>[u / focal, v / focal, 1]</p></td>
<td class="text-center"><p>/</p></td>
<td class="text-center"><p></p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>Model</p></td>
<td class="text-center"><p>[u, v, focal]</p></td>
<td class="text-center"><p>pixels</p></td>
<td class="text-center"><p>The sampled rectangle of the full camera frame the model uses.</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>Normalized Model</p></td>
<td class="text-center"><p>[u / focal, v / focal, 1]</p></td>
<td class="text-center"><p>/</p></td>
<td class="text-center"><p></p></td>
</tr>
</tbody>
</table>
</section>
<section id="orientation-conventions">
<h1>Orientation Conventions<a class="headerlink" href="#orientation-conventions" title="Link to this heading"></a></h1>
<p>Quaternions, rotation matrices and euler angles are three
equivalent representations of orientation and all three are
used throughout the code base.</p>
<p>For euler angles the preferred convention is [roll, pitch, yaw]
which corresponds to rotations around the [x, y, z] axes. All
euler angles should always be in radians or radians/s unless
for plotting or display purposes. For quaternions the hamilton
notations is preferred which is [q<sub>w</sub>, q<sub>x</sub>, q<sub>y</sub>, q<sub>z</sub>]. All quaternions
should always be normalized with a strictly positive q<sub>w</sub>. <strong>These
quaternions are a unique representation of orientation whereas euler angles
or rotation matrices are not.</strong></p>
<p>To rotate from one frame into another with euler angles the
convention is to rotate around roll, then pitch and then yaw,
while rotating around the rotated axes, not the original axes.</p>
</section>
<section id="car-frame">
<h1>Car frame<a class="headerlink" href="#car-frame" title="Link to this heading"></a></h1>
<p>Device frame is aligned with the road-facing camera used by openpilot. However, when controlling the vehicle it is helpful to think in a reference frame aligned with the vehicle. These two reference frames can be different.</p>
<p>The orientation of car frame is defined to be aligned with the car’s direction of travel and the road plane when the vehicle is driving on a flat road and not turning. The origin of car frame is defined to be directly below device frame (in car frame), such that it is on the road plane. The position and orientation of this frame is not necessarily always aligned with the direction of travel or the road plane due to suspension movements and other effects.</p>
</section>
<section id="calibrated-frame">
<h1>Calibrated frame<a class="headerlink" href="#calibrated-frame" title="Link to this heading"></a></h1>
<p>It is helpful for openpilot’s driving model to take in images that look similar when mounted differently in different cars. To achieve this we “calibrate” the images by transforming it into calibrated frame. Calibrated frame is defined to be aligned with car frame in pitch and yaw, and aligned with device frame in roll. It also has the same origin as device frame.</p>
</section>
<section id="example">
<h1>Example<a class="headerlink" href="#example" title="Link to this heading"></a></h1>
<p>To transform global Mesh3D positions and orientations (positions_ecef, quats_ecef) into the local frame described by the
first position and orientation from Mesh3D one would do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ecef_from_local</span> <span class="o">=</span> <span class="n">rot_from_quat</span><span class="p">(</span><span class="n">quats_ecef</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">local_from_ecef</span> <span class="o">=</span> <span class="n">ecef_from_local</span><span class="o">.</span><span class="n">T</span>
<span class="n">positions_local</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,kj-&gt;ki&#39;</span><span class="p">,</span> <span class="n">local_from_ecef</span><span class="p">,</span> <span class="n">postions_ecef</span> <span class="o">-</span> <span class="n">positions_ecef</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">rotations_global</span> <span class="o">=</span> <span class="n">rot_from_quat</span><span class="p">(</span><span class="n">quats_ecef</span><span class="p">)</span>
<span class="n">rotations_local</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,kjl-&gt;kil&#39;</span><span class="p">,</span> <span class="n">local_from_ecef</span><span class="p">,</span> <span class="n">rotations_global</span><span class="p">)</span>
<span class="n">eulers_local</span> <span class="o">=</span> <span class="n">euler_from_rot</span><span class="p">(</span><span class="n">rotations_local</span><span class="p">)</span>
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, comma.ai.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>