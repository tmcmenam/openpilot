<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />
<meta content="openpilot docs" name="description" />
<meta content="op, openpilot, docs, documentation" name="keywords" />
<meta content="all,follow" name="robots" />
<meta content="index,follow,snippet,archive" name="googlebot" />
<meta content="en_US" property="og:locale" />
<meta content="docs.comma.ai" property="og:site_name" />
<meta content="https://docs.comma.ai" property="og:url" />
<meta content="openpilot Documentation" property="og:title" />
<meta content="website" property="og:type" />
<meta content="image/jpeg" property="og:image:type" />
<meta content="400" property="og:image:width" />
<meta content="https://docs.comma.ai/_static/logo.png" property="og:image" />
<meta content="https://docs.comma.ai/_static/logo.png" property="og:image:url" />
<meta content="https://docs.comma.ai/_static/logo.png" property="og:image:secure_url" />
<meta content="openpilot Documentation" property="og:description" />
<meta content="summary_large_image" property="twitter:card" />
<meta content="https://docs.comma.ai/_static/logo.png" property="twitter:logo" />
<meta content="openpilot Documentation" property="twitter:title" />
<meta content="openpilot Documentation" property="twitter:description" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Apple Neural Engine &mdash; openpilot docs 0.9.5 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="canonical" href="https://docs.comma.ai/tinygrad_repo/accel/ane/README.html" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=61b282d3"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #000000" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            openpilot docs
              <img src="../../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.9.5
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">General</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../CARS.html">Supported Cars</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CARS.html#id1">265 Supported Cars</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CARS.html#don-t-see-your-car-here">Don’t see your car here?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CONTRIBUTING.html">How to contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../INTEGRATION.html">Integration with Stock Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../LIMITATIONS.html">Limitations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../SAFETY.html">Safety</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">openpilot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html#cereal">cereal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html#laika">laika</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html#models">models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html#opendbc">opendbc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html#panda">panda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html#rednose">rednose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html#tools">tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">openpilot</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">C/C++ API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../c_docs.html">openpilot</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #000000" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">openpilot docs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">The Apple Neural Engine</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/tinygrad_repo/accel/ane/README.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="the-apple-neural-engine">
<h1>The Apple Neural Engine<a class="headerlink" href="#the-apple-neural-engine" title="Link to this heading"></a></h1>
<p>The Apple Neural Engine is a fancy DMA Engine that is based around convolutions. We don’t have all the details worked out yet, but we can do some things with it. At its core, it runs through 0x300 ops in an hwx file. See <code class="docutils literal notranslate"><span class="pre">aneregs</span></code> for the registers used in each op.</p>
<p>It operates out of RAM or its 4MB L2 cache. The L2 “cache” appears to be manually managed, and only applies to the input and output, not the weights. The weights are usually included in the program, and it’s unclear where they are copied to.</p>
<p>The 16 cores likely refer to the 16 wide Kernel DMA engine. They claim 11 TOPS total, which would be 687.5 GOPS/core. Perhaps it’s a 32x32 MAC running at 335 MHz. That clock speed matches the cycle count time ratio from the debug perf stats.</p>
<p>It works with 5D Tensors, you specify the stride for the latter 4. All strides must be a multiple of 0x40 bytes</p>
<ul class="simple">
<li><p>Column (width)    – aneRegs.Common.InDim.Win / aneRegs.Common.OutDim.Wout</p></li>
<li><p>Row    (height)   – aneRegs.Common.InDim.Hin / aneRegs.Common.OutDim.Hout</p></li>
<li><p>Plane  (channels) – aneRegs.Common.Cin.Cin / aneRegs.Common.Cout.Cout</p></li>
<li><p>Depth</p></li>
<li><p>Group  (batch)    – aneRegs.Common.GroupConvCfg.NumGroups</p></li>
</ul>
<p>It works with 3 data types</p>
<ul class="simple">
<li><p>UInt8</p></li>
<li><p>Int8</p></li>
<li><p>Float16</p></li>
</ul>
<p>The ops have several parts</p>
<ul class="simple">
<li><p>Header – The base addresses for the DMA engines</p></li>
<li><p>KernelDMASrc – 16x wide DMA engine for the weights/bias/nonlinearity</p></li>
<li><p>Common – Specifies the parameters for the convolution</p></li>
<li><p>TileDMASrc – Input DMA engine</p></li>
<li><p>L2 – Use the L2 cache for Source/Result instead of RAM</p></li>
<li><p>NE – Configure Kernel/MAC/Post</p></li>
<li><p>TileDMADst – Output DMA engine</p></li>
</ul>
<p>It can work with 8 base addresses for the DMA streams per OP</p>
<ul class="simple">
<li><p>2x Read, both used for things like sum</p></li>
<li><p>1x Write</p></li>
<li><p>1x T?</p></li>
<li><p>4x Kernel, though only the first one seems used</p></li>
</ul>
<section id="normal-flow-for-ane-usage">
<h2>Normal Flow for ANE Usage<a class="headerlink" href="#normal-flow-for-ane-usage" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Keras/ONNX model -&gt; coremltools</p></li>
<li><p>CoreML model -&gt; Espresso</p></li>
<li><p>net.plist -&gt; ANECompiler</p></li>
<li><p>model.hwx -&gt; ANEServices</p></li>
<li><p>AppleH11ANEInterface, an IOKit interface to the kernel</p></li>
</ul>
</section>
<section id="hwx-file">
<h2>hwx file?<a class="headerlink" href="#hwx-file" title="Link to this heading"></a></h2>
<p>This is a Mach-O file. We haven’t figured out all the details, but the ops are at 0x4000. See <code class="docutils literal notranslate"><span class="pre">hwx_parse.py</span></code></p>
</section>
<section id="amfid">
<h2>amfid<a class="headerlink" href="#amfid" title="Link to this heading"></a></h2>
<p>Sadly disabling amfi breaks things like vscode. You can runtime patch</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># MacOS 12.4

smol :: ~/fun/tinygrad » sha1sum /usr/libexec/amfid 
0f7e7f7e41408f83d7ebc7564a3828f41cb2ab58  /usr/libexec/amfid

# with patching +0x8e38

(lldb) image list
[  0] 04B6DF6C-6068-3F18-81A7-978985574387 0x0000000102ad0000 /usr/libexec/amfid 
(lldb) p *(unsigned int *)0x102ad8e38=0xd2800000
</pre></div>
</div>
<p>This disables the entitlement check, then you don’t need a bootarg. I wish Apple made a better way to do this.</p>
</section>
<section id="extracting-aneservices-framework">
<h2>Extracting ANEServices.framework<a class="headerlink" href="#extracting-aneservices-framework" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># install xcode and </span>
<span class="n">sudo</span> <span class="n">xcode</span><span class="o">-</span><span class="n">select</span> <span class="o">--</span><span class="n">switch</span> <span class="o">/</span><span class="n">Applications</span><span class="o">/</span><span class="n">Xcode</span><span class="o">.</span><span class="n">app</span>
<span class="c1"># xcode also contains ANEServices.tbd</span>
<span class="n">brew</span> <span class="n">install</span> <span class="n">keith</span><span class="o">/</span><span class="n">formulae</span><span class="o">/</span><span class="n">dyld</span><span class="o">-</span><span class="n">shared</span><span class="o">-</span><span class="n">cache</span><span class="o">-</span><span class="n">extractor</span>
<span class="n">dyld</span><span class="o">-</span><span class="n">shared</span><span class="o">-</span><span class="n">cache</span><span class="o">-</span><span class="n">extractor</span> <span class="o">/</span><span class="n">System</span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">dyld</span><span class="o">/</span><span class="n">dyld_shared_cache_arm64e</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">libraries</span>
<span class="n">cp</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">libraries</span><span class="o">/</span><span class="n">System</span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">PrivateFrameworks</span><span class="o">/</span><span class="n">ANECompiler</span><span class="o">.</span><span class="n">framework</span><span class="o">/</span><span class="n">Versions</span><span class="o">/</span><span class="n">A</span><span class="o">/</span><span class="n">ANECompiler</span> <span class="o">.</span>
<span class="n">cp</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">libraries</span><span class="o">/</span><span class="n">System</span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">PrivateFrameworks</span><span class="o">/</span><span class="n">ANEServices</span><span class="o">.</span><span class="n">framework</span><span class="o">/</span><span class="n">Versions</span><span class="o">/</span><span class="n">A</span><span class="o">/</span><span class="n">ANEServices</span> <span class="o">.</span>
<span class="n">cp</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">libraries</span><span class="o">/</span><span class="n">System</span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">PrivateFrameworks</span><span class="o">/</span><span class="n">AppleNeuralEngine</span><span class="o">.</span><span class="n">framework</span><span class="o">/</span><span class="n">Versions</span><span class="o">/</span><span class="n">A</span><span class="o">/</span><span class="n">AppleNeuralEngine</span> <span class="o">.</span>
</pre></div>
</div>
</section>
<section id="other-work">
<h2>Other work<a class="headerlink" href="#other-work" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># sadly also relies on ZinIrRegBitPrintOutDebug
https://github.com/antgroup-arclab/ANETools.git

# sadly looks like we do actually need a direct connection to run hwx files, aned is at the espresso level
* frame #0: 0x00000001c250fecc AppleNeuralEngine`-[_ANEDaemonConnection loadModel:sandboxExtension:options:qos:withReply:]
(lldb) po $x2
_ANEModel: { modelURL=file:///var/folders/l8/38vj8bm52_gfgsqgdn__sh2w0000gn/T/test_F48D9B88-A68D-476F-ADC8-32BDAF9A2498.mlmodelc/ : key={&quot;isegment&quot;:0,&quot;inputs&quot;:{&quot;image&quot;:{&quot;shape&quot;:[1,1,1,64,1]},&quot;image2&quot;:{&quot;shape&quot;:[1,1,1,64,1]}},&quot;outputs&quot;:{&quot;probs&quot;:{&quot;shape&quot;:[1,1,1,64,1]}}} : string_id=0x00000000 : program=(null) : state=1 : programHandle=0 : intermediateBufferHandle=0 : queueDepth=0 : attr={
} : perfStatsMask=0} 
</pre></div>
</div>
</section>
<section id="choices">
<h2>Choices<a class="headerlink" href="#choices" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Disable amfid (breaks vscode)</p></li>
<li><p>Patch amfid to allow restricted entitlements</p></li>
<li><p>Sign with a “provisioning profile” to allow the entitlement</p></li>
<li><p>Patch the ANE kext to not require a special entitlement (this is ideal, as we don’t need to resign python)</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, comma.ai.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>