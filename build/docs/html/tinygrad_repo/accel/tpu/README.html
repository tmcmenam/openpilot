<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />
<meta content="openpilot docs" name="description" />
<meta content="op, openpilot, docs, documentation" name="keywords" />
<meta content="all,follow" name="robots" />
<meta content="index,follow,snippet,archive" name="googlebot" />
<meta content="en_US" property="og:locale" />
<meta content="docs.comma.ai" property="og:site_name" />
<meta content="https://docs.comma.ai" property="og:url" />
<meta content="openpilot Documentation" property="og:title" />
<meta content="website" property="og:type" />
<meta content="image/jpeg" property="og:image:type" />
<meta content="400" property="og:image:width" />
<meta content="https://docs.comma.ai/_static/logo.png" property="og:image" />
<meta content="https://docs.comma.ai/_static/logo.png" property="og:image:url" />
<meta content="https://docs.comma.ai/_static/logo.png" property="og:image:secure_url" />
<meta content="openpilot Documentation" property="og:description" />
<meta content="summary_large_image" property="twitter:card" />
<meta content="https://docs.comma.ai/_static/logo.png" property="twitter:logo" />
<meta content="openpilot Documentation" property="twitter:title" />
<meta content="openpilot Documentation" property="twitter:description" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Google’s TPU &mdash; openpilot docs 0.9.5 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="canonical" href="https://docs.comma.ai/tinygrad_repo/accel/tpu/README.html" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=61b282d3"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #000000" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            openpilot docs
              <img src="../../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.9.5
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">General</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../CARS.html">Supported Cars</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CARS.html#id1">265 Supported Cars</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CARS.html#don-t-see-your-car-here">Don’t see your car here?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CONTRIBUTING.html">How to contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../INTEGRATION.html">Integration with Stock Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../LIMITATIONS.html">Limitations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../SAFETY.html">Safety</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">openpilot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html#cereal">cereal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html#laika">laika</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html#models">models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html#opendbc">opendbc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html#panda">panda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html#rednose">rednose</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html#tools">tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">openpilot</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">C/C++ API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../c_docs.html">openpilot</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #000000" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">openpilot docs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Google’s TPU</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/tinygrad_repo/accel/tpu/README.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="google-s-tpu">
<h1>Google’s TPU<a class="headerlink" href="#google-s-tpu" title="Link to this heading"></a></h1>
<p>We document the Google TPU v2/v3 in order to support it in tinygrad without the XLA compiler.</p>
</section>
<section id="creating-a-google-cloud-tpu-vm">
<h1>Creating a Google Cloud TPU VM<a class="headerlink" href="#creating-a-google-cloud-tpu-vm" title="Link to this heading"></a></h1>
<p>This costs $4.50/hr for a TPUv2-8 machine, the cheapest VM.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gcloud<span class="w"> </span>alpha<span class="w"> </span>compute<span class="w"> </span>tpus<span class="w"> </span>tpu-vm<span class="w"> </span>create<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--zone<span class="o">=</span>us-central1-b<span class="w"> </span>--accelerator-type<span class="o">=</span>v2-8<span class="w"> </span>--version<span class="o">=</span>v2-alpha
gcloud<span class="w"> </span>alpha<span class="w"> </span>compute<span class="w"> </span>tpus<span class="w"> </span>tpu-vm<span class="w"> </span>ssh<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--zone<span class="w"> </span>us-central1-b
<span class="c1"># and for when you are done</span>
gcloud<span class="w"> </span>alpha<span class="w"> </span>compute<span class="w"> </span>tpus<span class="w"> </span>tpu-vm<span class="w"> </span>delete<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--zone<span class="w"> </span>us-central1-b
gcloud<span class="w"> </span>alpha<span class="w"> </span>compute<span class="w"> </span>tpus<span class="w"> </span>tpu-vm<span class="w"> </span>list<span class="w"> </span>--zone<span class="w"> </span>us-central1-b
</pre></div>
</div>
<p>Aside from the usual VM stuff, there’s 4 accelerators on the PCI-E bus. (v2-8 is 4 chips with 2 cores each)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># lspci
00:04.0 Unassigned class [ff00]: Google, Inc. Device 0027
00:05.0 Unassigned class [ff00]: Google, Inc. Device 0027
00:06.0 Unassigned class [ff00]: Google, Inc. Device 0027
00:07.0 Unassigned class [ff00]: Google, Inc. Device 0027
</pre></div>
</div>
<p>They show up in <code class="docutils literal notranslate"><span class="pre">/sys/class/accel</span></code> (tons of files here) and the driver lives in <code class="docutils literal notranslate"><span class="pre">/lib/libtpu.so</span></code>. The devices are in <code class="docutils literal notranslate"><span class="pre">/dev/accel[0-3]</span></code>, and a bunch of stuff is mmaped. They are “ba16c7433” chips.</p>
<p>We grab the minimal TPU <a class="reference external" href="https://github.com/tensorflow/tensorflow/blob/695b4c93d5da7277eb845937b79b66f9f363ed94/tensorflow/compiler/xla/python/tpu_driver/client/libtpu_client.c">example from TensorFlow</a>. When the compiler runs, it produces tons of great logs in <code class="docutils literal notranslate"><span class="pre">/tmp/tpu_logs</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>tfexample
gcc<span class="w"> </span>-o<span class="w"> </span>libtpu_client<span class="w"> </span>libtpu_client.c<span class="w"> </span>-ltpu
<span class="nv">TPU_VLOG_LEVEL</span><span class="o">=</span><span class="m">99</span><span class="w"> </span>./libtpu_client
</pre></div>
</div>
<p>From these logs, we find the “LLO Instructions”</p>
</section>
<section id="vliw-instruction-322b-vliw-bundle">
<h1>VLIW Instruction (322b VLIW bundle)<a class="headerlink" href="#vliw-instruction-322b-vliw-bundle" title="Link to this heading"></a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  spare         : 0   (0,1)
  vex_mxu       : 0   (1,1)
* 1 misc slot
  msc_targ      : 0   (2,3)
  msc_opnd      : 0   (5,3)
  msc_op        : 0   (8,5)
  msc_pred      : 31  (13,5)
* 2 matrix slots (push, pop)
  vres_dest     : 28  (18,2)
  vres_op       : 28  (20,2)
  vres_pred     : 31  (22,5)
  vex_source    : 28  (27,2)
  vex_subop     : 24  (29,3)
  vex_op        : 24  (32,3)
  vex_pred      : 31  (35,5)
* 4 vector slots (2 for load/store)
  vld_ttu       : 30  (40,1)
  vld_stride    : 24  (41,3)
  vld_offset    : 24  (44,2)
  vld_base      : 24  (46,2)
  vld_submsk    : 24  (48,3)
  vld_dest      : 0   (51,5)
  vld_op        : 0   (56,2)
  vld_pred      : 31  (58,5)
  vst_ttu       : 30  (63,1)
  vst_iar       : 30  (64,1)
  vst_value_two : 24  (65,3)
  vst_offset    : 24  (68,2)
  vst_base      : 24  (70,2)
  vst_value_one : 24  (72,3)
  vst_source    : 0   (75,5)
  vst_op        : 0   (80,5)
  vst_pred      : 31  (85,5)
* 4 vector slots (2 for ALU)
  v1_dest       : 0   (90,5)
  v1_y_vreg     : 0   (95,5)
  v1_y_src      : 0   (100,5)
  v1_x          : 0   (105,5)
  v1_op         : 0   (110,6)
  v1_pred       : 31  (116,5)
  v0_dest       : 0   (121,5)
  v0_y_vreg     : 0   (126,5)
  v0_y_src      : 0   (131,5)
  v0_x          : 0   (136,5)
  v0_op         : 0   (141,6)
  v0_pred       : 31  (147,5)
* 3 scalar registers copied in to the vector units?
  vs2           : 0   (152,5)
  vs1           : 0   (157,5)
  vs0           : 0   (162,5)
* 6 immediates (16-bit each, two can be merged for 32)
  imm_5         : 0   (167,16)
  imm_4         : 0   (183,16)
  imm_3         : 0   (199,16)
  imm_2         : 0   (215,16)
  imm_1         : 0   (231,16)
  imm_0         : 0   (247,16)
* ttu? what&#39;s a ttu?
  ttu_set_btr   : 0   (263,1)
  ttu_iterate   : 0   (264,1)
  ttu_row       : 0   (265,3)
* 2 scalar slots
  s1_dest       : 0   (268,5)
  s1_y          : 0   (273,6)
  s1_x          : 0   (279,5)
  s1_op         : 0   (284,6)
  s1_pred       : 31  (290,5)
  s0_dest       : 0   (295,5)
  s0_y          : 0   (300,6)
  s0_x          : 0   (306,5)
  s0_op         : 0   (311,6)
  s0_pred       : 15  (317,5)
</pre></div>
</div>
</section>
<section id="running-a-program-wip">
<h1>Running a Program (WIP)<a class="headerlink" href="#running-a-program-wip" title="Link to this heading"></a></h1>
<p>Our goal is to run a program on TPU without the driver.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">openat</span><span class="p">(</span><span class="n">AT_FDCWD</span><span class="p">,</span> <span class="s2">&quot;/dev/accel3&quot;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">)</span> <span class="o">=</span> <span class="mi">184</span>
<span class="n">mmap</span><span class="p">(</span><span class="n">NULL</span><span class="p">,</span> <span class="mi">27799736</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="o">|</span><span class="n">MAP_LOCKED</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x7f59a74b3000</span>
<span class="c1"># size is 0x1a830b8, aka 28MB</span>
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, comma.ai.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>